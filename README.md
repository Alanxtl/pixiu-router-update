# pixiu-router-update

## old trie implementation benchmark result

æ³¨æ„ï¼šç”±äºTrieåŸå§‹æ•°æ®ç»“æ„ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒBenchmarkMatchParallelæµ‹è¯•ä»…åœ¨â€œæ— å†™å…¥â€çš„ç†æƒ³æƒ…å†µä¸‹æ‰èƒ½æˆåŠŸè¿è¡Œã€‚

```
goos: linux
goarch: amd64
pkg: github.com/alanxtl/pixiu-router-update
cpu: Intel(R) Core(TM) Ultra 5 125H
BenchmarkRouterPerformance/PathOnly-100-Routes-18         	 8599695	       149.6 ns/op	     160 B/op	       5 allocs/op
BenchmarkRouterPerformance/PathOnly-1000-Routes-18        	 5471448	       221.8 ns/op	     160 B/op	       5 allocs/op
BenchmarkRouterPerformance/PathOnly-10000-Routes-18       	  990483	      1230 ns/op	     160 B/op	       5 allocs/op
BenchmarkRouterPerformance/HeaderOnly-100-Routes-18       	 2761293	       411.1 ns/op	       8 B/op	       1 allocs/op
BenchmarkRouterPerformance/HeaderOnly-1000-Routes-18      	  284982	      4154 ns/op	       8 B/op	       1 allocs/op
BenchmarkRouterPerformance/HeaderOnly-10000-Routes-18     	   31845	     37987 ns/op	       8 B/op	       1 allocs/op
BenchmarkRouterWithContention/RouterWithContention-100-Routes-18         	 8034261	       150.0 ns/op	     160 B/op	       5 allocs/op
BenchmarkRouterWithContention/RouterWithContention-1000-Routes-18        	 5257695	       229.8 ns/op	     160 B/op	       5 allocs/op
BenchmarkRouterWithContention/RouterWithContention-10000-Routes-18       	  918974	      1327 ns/op	     160 B/op	       5 allocs/op
BenchmarkTrieMatch/Routes-100-18                                         	 6678661	       161.2 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatch/Routes-1000-18                                        	 5993542	       199.5 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatch/Routes-10000-18                                       	 5268208	       231.9 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatch/Routes-100000-18                                      	 4065294	       307.4 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatchParallel/Routes-100-18                                 	18814371	        60.73 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatchParallel/Routes-1000-18                                	16890303	        72.34 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatchParallel/Routes-10000-18                               	17749135	        62.41 ns/op	      96 B/op	       2 allocs/op
BenchmarkTrieMatchParallel/Routes-100000-18                              	16548598	        66.48 ns/op	      96 B/op	       2 allocs/op
BenchmarkTriePut/Add-New-Routes-18                                       	 1000000	      1135 ns/op	     691 B/op	       9 allocs/op
PASS
ok  	github.com/alanxtl/pixiu-router-update	26.811s
```

åº•å±‚çš„**Trieæ•°æ®ç»“æ„æå…¶å¿«é€Ÿä¸”å¯æ‰©å±•**ï¼Œè€Œ**`RouterCoordinator`å®ç°å±‚å¼•å…¥äº†ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆ**ï¼Œåœ¨è§„æ¨¡åŒ–æ—¶æŠµæ¶ˆäº†Trieçš„ä¼˜åŠ¿ã€‚

***

### **æ‰§è¡Œæ‘˜è¦** ğŸ“œ

* **Trieæ ¸å¿ƒè¡¨ç°ä¼˜å¼‚**ï¼šç‹¬ç«‹çš„Trieï¼ˆ`BenchmarkTrieMatch`ï¼‰è¡¨ç°å‡ºå®Œç¾çš„å¯æ‰©å±•æ€§ï¼Œéšç€è·¯ç”±æ•°é‡å¢åŠ 1000å€ï¼Œæ€§èƒ½ä»…è½»å¾®ä¸‹é™ã€‚
* **`RouterCoordinator`ç“¶é¢ˆ**ï¼š`RouterCoordinator`çš„è·¯å¾„è·¯ç”±ï¼ˆ`PathOnly`ï¼‰å­˜åœ¨ä¸¥é‡çš„å®ç°é—®é¢˜ï¼Œå¯¼è‡´æ€§èƒ½åœ¨è§„æ¨¡åŒ–æ—¶å‰§çƒˆä¸”æ„å¤–åœ°ä¸‹é™ã€‚
* **å¤´éƒ¨è·¯ç”±æ˜¯æ€§èƒ½é™·é˜±**ï¼šåŸºäºHTTPå¤´çš„è·¯ç”±ï¼ˆ`HeaderOnly`ï¼‰è¢«ç¡®è®¤æ˜¯çº¿æ€§æ‰«ææ“ä½œï¼ˆO(N)ï¼‰ï¼Œéšç€è§„åˆ™æ•°é‡çš„å¢åŠ ï¼Œå¯¼è‡´æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚
* **`RWMutex`ç«äº‰ä¸¥é‡**ï¼šè™½ç„¶å†™æ“ä½œå¯¹è¯»å–å»¶è¿Ÿå½±å“è¾ƒå°ï¼Œä½†åå‘å½±å“æ˜¯ç¾éš¾æ€§çš„ã€‚é«˜è¯»å–æµé‡å¯èƒ½å°†å•æ¬¡é…ç½®æ›´æ–°çš„å»¶è¿Ÿå¢åŠ è‡³**80å€**ï¼Œå¯¹æ“ä½œçµæ´»æ€§æ„æˆé‡å¤§é£é™©ã€‚

***

### **è¯¦ç»†æ€§èƒ½åˆ†æ**

#### **å¥½çš„æ–¹é¢ï¼šåº•å±‚Trieæ€§èƒ½ï¼ˆåŸºå‡†ï¼‰**

`BenchmarkTrieMatch`ç»“æœä¸ºè·¯ç”±æ€§èƒ½è®¾å®šäº†æ˜ç¡®çš„åŸºå‡†ã€‚

| Trieè·¯ç”±æ•°é‡ | å•æ ¸å¹³å‡å»¶è¿Ÿ | å¤šæ ¸å¹³å‡å»¶è¿Ÿ | å¯æ‰©å±•æ€§åˆ†æ |
| :--- | :--- | :--- | :--- |
| 100 | 168.0 ns | 64.92 ns | ï¼ˆåŸºå‡†ï¼‰ |
| 1,000 | 208.0 ns | 77.97 ns | ä¼˜ç§€ |
| 10,000 | 235.5 ns | 61.92 ns | ä¼˜ç§€ |
| 100,000 | 294.3 ns | 63.71 ns | **ä¼˜ç§€** |

* **å“è¶Šå¯æ‰©å±•æ€§**ï¼šå½“è·¯ç”±æ•°é‡å¢åŠ 1000å€ï¼ˆä»100åˆ°100,000ï¼‰æ—¶ï¼Œå•æ ¸å»¶è¿Ÿä»…å¢åŠ **75%**ï¼ˆä»168nsåˆ°294nsï¼‰ã€‚è¿™è¯æ˜äº†Trieçš„æ€§èƒ½ä¸è§„åˆ™æ€»æ•°æ— å…³ï¼Œè€Œæ˜¯ä¸è·¯å¾„çš„æ·±åº¦æœ‰å…³ï¼Œè¿™æ­£æ˜¯æ‰€æœŸæœ›çš„è¡Œä¸ºã€‚
* **é«˜ååé‡**ï¼šåœ¨100,000æ¡è·¯ç”±ä¸‹ï¼ŒTrieå¯ä»¥åœ¨å•æ ¸ä¸Šæ‰§è¡Œçº¦340ä¸‡æ¬¡åŒ¹é…ï¼Œæ¯ç§’åœ¨å¹¶è¡Œæ—¶è¶…è¿‡**1500ä¸‡æ¬¡åŒ¹é…**ã€‚

***

#### **ä¸å¥½çš„æ–¹é¢ï¼š`RouterCoordinator`æ€§èƒ½ä¸‹é™**

é€šè¿‡`RouterCoordinator`åŒ…è£…ä½¿ç”¨Trieæ—¶ï¼Œæ€§èƒ½æ•…äº‹å‘ç”Ÿäº†å‰§çƒˆå˜åŒ–ã€‚

| è·¯ç”±æ•°é‡ | åº•å±‚Trieå»¶è¿Ÿï¼ˆns/opï¼‰ | `RouterCoordinator`å»¶è¿Ÿï¼ˆns/opï¼‰ | **åŒ…è£…å¼€é”€** |
| :--- | :--- | :--- | :--- |
| 100 | 168.0 ns | 141.1 ns | -16%ï¼ˆå¯å¿½ç•¥ï¼‰ |
| 1,000 | 208.0 ns | 212.7 ns | +2%ï¼ˆå¯æ¥å—ï¼‰ |
| **10,000** | **235.5 ns** | **1180 ns** | **+400%ï¼ˆä¸¥é‡ä¸‹é™ï¼‰** |

* **é—®é¢˜**ï¼šæ•°æ®æ¸…æ¥šåœ°æ˜¾ç¤º`RouterCoordinator`å±‚åœ¨10,000æ¡è·¯ç”±æ—¶å¼•å…¥äº†å·¨å¤§çš„**400%æ€§èƒ½å¼€é”€**ã€‚åŒ…è£…çš„å®ç°å­˜åœ¨æ‰©å±•æ€§é—®é¢˜ï¼ŒæŠµæ¶ˆäº†ä½¿ç”¨Trieçš„ä¸»è¦å¥½å¤„ã€‚
* **ç»“è®º**ï¼šæ€§èƒ½ç“¶é¢ˆ**ä¸**åœ¨äºæ ¸å¿ƒTrieæ•°æ®ç»“æ„ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨å®ƒçš„ä¸šåŠ¡é€»è¾‘å±‚ã€‚

***

#### **ä¸‘é™‹çš„æ–¹é¢ï¼šå¤´éƒ¨è·¯ç”±å’Œé”ç«äº‰**

##### **åŸºäºå¤´éƒ¨çš„è·¯ç”±**

| å¤´éƒ¨è·¯ç”±æ•°é‡ | å¹³å‡å»¶è¿Ÿï¼ˆns/opï¼‰ | ä¸100æ¡è·¯ç”±çš„æ€§èƒ½æ¯”è¾ƒ |
| :--- | :--- | :--- |
| 100 | 426.7 ns | ï¼ˆåŸºå‡†ï¼‰ |
| 1,000 | 4062 ns | **æ…¢9.5å€** |
| 10,000 | 40061 ns | **æ…¢94å€** |

* **çº¿æ€§æ‰©å±•ç¡®è®¤**ï¼šéšç€è§„åˆ™æ•°é‡å¢åŠ ï¼Œæ€§èƒ½çº¿æ€§ä¸‹é™ã€‚åœ¨10,000æ¡è·¯ç”±ä¸‹ï¼Œå•æ¬¡åŒ¹é…è€—æ—¶è¶…è¿‡**40å¾®ç§’**ï¼Œè¿™å¯¹äºé«˜æ€§èƒ½ç½‘å…³è€Œè¨€æ˜¯ä¸å¯æ¥å—çš„ã€‚åº”é¿å…åœ¨å¤§è§„åˆ™é›†ä¸Šä½¿ç”¨è¿™ç§è·¯ç”±æ–¹æ³•ã€‚

##### **è¯»/å†™é”ç«äº‰**

æ­¤åˆ†ææ­ç¤ºäº†ä½¿ç”¨æ ‡å‡†`RWMutex`çš„åŒå‘æˆæœ¬ã€‚

1. **å†™æ“ä½œå¯¹è¯»çš„å½±å“**ï¼š
    * **åŸºå‡†ï¼ˆ10kè·¯ç”±ï¼Œæ— å†™æ“ä½œï¼‰**ï¼š1180 ns/op
    * **æœ‰ç«äº‰ï¼ˆ10kè·¯ç”±ï¼Œæœ‰å†™æ“ä½œï¼‰**ï¼š1309 ns/op
    * **å½±å“**ï¼šé…ç½®æ›´æ–°å¯¼è‡´å¹³å‡è¯»å–å»¶è¿Ÿ**å¢åŠ 11%**ã€‚

2. **è¯»æ“ä½œå¯¹å†™çš„å½±å“ï¼ˆå…³é”®é—®é¢˜ï¼‰**ï¼š
    * **åŸºå‡†ï¼ˆ10kè·¯ç”±ï¼Œæ— è¯»æ“ä½œï¼‰**ï¼š2721 ns/opï¼ˆçº¦2.7å¾®ç§’ï¼‰
    * **æœ‰ç«äº‰ï¼ˆ10kè·¯ç”±ï¼Œæœ‰è¯»æ“ä½œï¼‰**ï¼š218709 ns/opï¼ˆçº¦218.7å¾®ç§’ï¼‰
    * **å½±å“**ï¼šé«˜è¯»å–æµé‡ä½¿å†™æ“ä½œ**å˜æ…¢80å€**ã€‚ä¸€ä¸ªåº”åœ¨çº¦3å¾®ç§’å†…å®Œæˆçš„é…ç½®æ›´æ–°ç°åœ¨éœ€è¦è¶…è¿‡200å¾®ç§’ï¼Œå› ä¸ºå®ƒå¿…é¡»ç­‰å¾…æ‰€æœ‰å¹¶å‘è¯»å–æ“ä½œå®Œæˆã€‚

***